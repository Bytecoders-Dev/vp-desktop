name: release

on:
  push:
    tags:
      - "v*.*.*"

permissions:
  contents: write

jobs:
  build-windows:
    runs-on: windows-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install deps
        run: npm ci

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Clean Tauri target
        shell: pwsh
        run: |
          if (Test-Path "src-tauri\target") { Remove-Item -Recurse -Force "src-tauri\target" }

      - name: Build Tauri (prod config)
        env:
          TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}
          TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY_PASSWORD }}
        run: npm run tauri build -- --config src-tauri/tauri.conf.json

      - name: Debug - list bundle nsis output
        shell: pwsh
        run: |
          Write-Host "=== src-tauri/target/release/bundle/nsis ==="
          Get-ChildItem -Recurse "src-tauri\target\release\bundle\nsis" | Select-Object FullName

      - name: Collect assets
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Force -Path assets | Out-Null

          if (Test-Path "src-tauri\target\release\bundle") {
            Copy-Item -Recurse -Force "src-tauri\target\release\bundle\*" "assets\" -ErrorAction SilentlyContinue
          }

          Write-Host "=== Assets copied ==="
          Get-ChildItem -Recurse assets | Select-Object FullName

      - name: Create latest.json (Windows - NSIS zip + sig)
        shell: pwsh
        run: |
          $tag = "${{ github.ref_name }}"
          $version = $tag.Replace("v","")
          $ownerRepo = "${{ github.repository }}"
          $pubDate = (Get-Date).ToUniversalTime().ToString("yyyy-MM-ddTHH:mm:ssZ")

          # Busca el zip de updater (v1Compatible)
          $zip = Get-ChildItem -Path assets -Recurse -Filter "*.nsis.zip" | Select-Object -First 1
          if (-not $zip) {
            throw "No *.nsis.zip found in assets. Ensure tauri.conf.json bundle.createUpdaterArtifacts is set to 'v1Compatible'."
          }

          # Validar que el nombre del zip contenga la versi√≥n del tag
          if ($zip.Name -notmatch [regex]::Escape($version)) {
            throw "Updater zip name does not match tag version. Tag=$version Zip=$($zip.Name). You are likely uploading old artifacts."
          }

          $sigFile = Get-ChildItem -Path $zip.DirectoryName -Filter "$($zip.Name).sig" -ErrorAction SilentlyContinue | Select-Object -First 1
          if (-not $sigFile) { throw "No .sig found for zip: $($zip.FullName)" }

          $sig = (Get-Content $sigFile.FullName -Raw).Trim()

          # URL encoding del nombre del archivo
          $encodedName = [uri]::EscapeDataString($zip.Name)
          $url = "https://github.com/$ownerRepo/releases/download/$tag/$encodedName"

          $latest = @{
            version = $version
            notes = "Ver notas en GitHub Release."
            pub_date = $pubDate
            platforms = @{
              "windows-x86_64" = @{
                url = $url
                signature = $sig
              }
            }
          } | ConvertTo-Json -Depth 10

          $latest | Out-File -FilePath "assets\latest.json" -Encoding utf8
          Get-Content "assets\latest.json"

      - name: Debug - list installers and sigs
        shell: pwsh
        run: |
          Write-Host "=== EXE files ==="
          Get-ChildItem -Path assets -Recurse -Filter "*.exe" | Select-Object FullName

          Write-Host "=== MSI files ==="
          Get-ChildItem -Path assets -Recurse -Filter "*.msi" | Select-Object FullName

          Write-Host "=== SIG files ==="
          Get-ChildItem -Path assets -Recurse -Filter "*.sig" | Select-Object FullName

      - name: Create GitHub Release + upload assets
        uses: softprops/action-gh-release@v2
        with:
          files: assets/**
          generate_release_notes: true
