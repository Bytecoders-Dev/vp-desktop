name: release

on:
  push:
    tags:
      - "v*.*.*"

permissions:
  contents: write

jobs:
  build-windows:
    runs-on: windows-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install deps
        run: npm ci

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Build Tauri (prod config)
        env:
          TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}
          TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY_PASSWORD }}
        run: npm run tauri build -- --config src-tauri/tauri.conf.json

      - name: Collect assets
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Force -Path assets | Out-Null

          if (Test-Path "src-tauri\target\release\bundle") {
            Copy-Item -Recurse -Force "src-tauri\target\release\bundle\*" "assets\" -ErrorAction SilentlyContinue
          }

          Write-Host "=== Assets copied ==="
          Get-ChildItem -Recurse assets | Select-Object FullName

      - name: Create latest.json (prefer NSIS setup.exe)
        shell: pwsh
        run: |
          $tag = "${{ github.ref_name }}"
          $version = $tag.Replace("v","")
          $ownerRepo = "${{ github.repository }}"
          $pubDate = (Get-Date).ToUniversalTime().ToString("yyyy-MM-ddTHH:mm:ssZ")

          # Prefer NSIS setup exe (e.g. VP 360_0.1.0_x64-setup.exe)
          $exe = Get-ChildItem -Path assets -Recurse -Filter "*-setup.exe" | Select-Object -First 1
          if (-not $exe) { throw "No *-setup.exe found in assets. Check nsis output." }

          # Signature next to exe
          $sigFile = Get-ChildItem -Path $exe.DirectoryName -Filter "$($exe.Name).sig" -ErrorAction SilentlyContinue | Select-Object -First 1
          if (-not $sigFile) { throw "No .sig found for exe: $($exe.FullName)" }

          $sig = (Get-Content $sigFile.FullName -Raw).Trim()
          $url = "https://github.com/$ownerRepo/releases/download/$tag/$($exe.Name)"

          $latest = @{
            version = $version
            notes = "Ver notas en GitHub Release."
            pub_date = $pubDate
            platforms = @{
              "windows-x86_64" = @{
                url = $url
                signature = $sig
              }
            }
          } | ConvertTo-Json -Depth 10

          $latest | Out-File -FilePath "assets\latest.json" -Encoding utf8
          Get-Content "assets\latest.json"

      - name: Create GitHub Release + upload assets
        uses: softprops/action-gh-release@v2
        with:
          files: assets/**
          generate_release_notes: true
